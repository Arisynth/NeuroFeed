# Microsoft OAuth 2.0 设置指南

本指南将帮助您设置Microsoft OAuth 2.0认证，以便NewsDigest应用可以通过Office 365或Outlook发送邮件。

## 步骤1: 在Azure门户中注册应用程序

1. 打开 [Azure门户](https://portal.azure.com/)
2. 登录您的Microsoft账户
3. 在左侧菜单中选择 "Azure Active Directory"
4. 在Azure AD菜单中点击 "应用注册"
5. 点击页面顶部的 "新注册"

## 步骤2: 注册应用的详细信息

1. 输入应用名称，如 "NewsDigest Email Client"
2. 选择支持的账户类型
   - 重要：为个人账户，选择 "仅此组织目录中的账户"
   - 如果要同时支持个人和工作账户，选择 "任何组织目录(任何Azure AD目录 - 多租户)中的账户和个人Microsoft账户"
3. 不需要设置重定向URI (我们使用客户端凭据流)
4. 点击 "注册"

## 步骤3: 获取Client ID和Tenant ID

1. 应用注册后，您将被定向到应用程序的概览页面
2. 复制 "应用程序(客户端)ID" - 这是您在NewsDigest中需要输入的Client ID
3. 复制 "目录(租户)ID" - 这是您在NewsDigest中需要输入的Tenant ID
   - **重要：** 使用您的实际租户ID，而不是"common"

## 步骤4: 创建Client Secret

1. 在左侧菜单中点击 "证书和密码"
2. 在 "客户端密码" 部分，点击 "新客户端密码"
3. 添加描述并选择过期时间
4. 点击 "添加"
5. **重要:** 立即复制显示的密码值 - 它只会显示一次，无法稍后查看

## 步骤5: 配置API权限并授权

1. 在左侧菜单中点击 "API权限"
2. 点击 "添加权限"
3. 选择 "Microsoft Graph"
4. 选择 "应用程序权限"
5. 搜索 "SMTP" 并勾选 "SMTP.Send"
6. 点击 "添加权限"
7. **重要：** 点击 "代表xxx授予管理员同意" 按钮
   - 这一步必须完成，否则会出现"缺少服务主体"错误

## 步骤6: 确保服务主体创建

如果您遇到"缺少服务主体"错误，请执行以下额外步骤：

1. 在Azure门户左侧菜单选择 "Azure Active Directory"
2. 选择 "企业应用程序"
3. 在列表中查找您的应用（可能需要点击"所有应用程序"）
4. 如果找不到应用，请点击 "新建应用程序" > "所有" > "创建自己的应用程序"
5. 输入同样的应用名称，选择 "将任何应用程序注册(非库)"
6. 创建后，记下"应用程序ID"，确保与您的客户端ID匹配
7. 返回"API权限"页面，重新授予管理员同意

## 步骤7: 在NewsDigest中配置

1. 打开NewsDigest应用并进入设置
2. 在Email选项卡中：
   - SMTP服务器: smtp.office365.com
   - 端口: 587
   - 安全性: STARTTLS
   - 认证方法: OAuth 2.0
3. 填写您的邮箱地址
4. 填写上面获取的Client ID和Client Secret
5. **重要：** Tenant ID填写您在步骤3复制的实际租户ID（不要使用"common"）

## 常见问题解决

### 错误：缺少服务主体或invalid_client

如果遇到"客户端应用程序缺少服务主体"或"invalid_client"错误：

1. 确保在正确的租户中注册了应用
2. 验证您已点击"授予管理员同意"按钮
3. 使用实际的租户ID，而不是"common"
4. 确保已在"企业应用程序"中创建了应用

### 错误：权限不足

如果遇到权限相关错误：

1. 检查是否授予了SMTP.Send权限
2. 确认登录的账户具有管理员权限
3. 尝试删除并重新创建应用注册

## 故障排除指南

如果您在使用OAuth连接Microsoft邮件服务时遇到问题，请尝试以下故障排除步骤：

### 1. 验证基本设置

- **确认SMTP服务器设置**：
  - 服务器: smtp.office365.com
  - 端口: 587
  - 安全性: STARTTLS

- **确认OAuth凭据**：
  - 客户端ID是否正确复制
  - 客户端密钥是否正确，没有多余的空格
  - 租户ID是否正确(不要使用"common"，而是使用实际的租户ID)

### 2. 解决常见OAuth错误

#### "invalid_client" 错误
这通常表示应用程序注册有问题：
1. 确保在**正确的Azure租户**中注册了应用
2. 检查客户端ID和密钥是否正确
3. 客户端密钥可能已过期，尝试创建新的密钥
4. 租户ID必须是应用程序注册所在的实际租户ID

#### "缺少服务主体" 错误
这表示应用程序注册不完整：
1. 前往Azure门户 > Azure Active Directory > 企业应用程序
2. 查找您的应用(如果找不到，创建一个与您注册同名的应用)
3. 确认应用程序ID与您使用的客户端ID匹配
4. 返回API权限，重新授予管理员同意

#### "权限不足" 错误
1. 确保添加了**应用程序权限**(而不是委托权限)
2. 确保选择了"SMTP.Send"权限
3. 确保点击了"授予管理员同意"按钮

### 3. 进阶故障排除

如果上述方法不能解决问题，请尝试：

1. **完全重新创建应用**：
   - 删除现有应用注册
   - 创建全新的应用注册
   - 重新设置所有权限和密钥

2. **使用Graph Explorer测试**：
   - 在[Graph Explorer](https://developer.microsoft.com/en-us/graph/graph-explorer)中测试您的凭据
   - 这可以确认您的凭据是否有效

3. **检查日志**：
   - 查看应用日志中的详细错误信息
   - 关注诸如"correlation_id"等错误代码

4. **确认账户权限**：
   - 确保用于测试的账户在租户中有足够权限
   - 免费或试用账户可能有一些限制
